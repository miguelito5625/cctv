<script>
    $(document).ready(function () {
        jQuery("time.timeago").timeago();

        btnEdit.disabled = true;
        btnDelete.disabled = true;
        btnState.disabled = true;
        // document.getElementById("btnState").innerHTML = 'Lock';
        const socket = io();

        //temporalmente se guarda el registro de la fila seleccionada
        var row_array;

        $('#tableCabinets').DataTable({
            ajax: {
                url: "/cabinets/list",
                type: "post",
                dataSrc: "Gabinetes"
            },
            columns: [
                { data: "id" },
                { data: "identificador" },
                { data: "ubicacion" },
                { data: "coordenadas" },
                { data: "updated_at" },
                { data: "created_at" },
                { data: "estado" }
            ],

            language: {
                "url": "https://wifinet.ga/json/datatables-es.json"
            },

            //Ocultar columna
            "columnDefs": [
                {
                    "targets": [0],
                    "visible": false
                },
                {
                    "targets": [4],
                    "render": function (data, type, row, meta) {
                        return jQuery.timeago(data);
                    }
                },
                {
                    "targets": [5],
                    "render": function (data, type, row, meta) {
                        return jQuery.timeago(data);
                    }
                }

            ]

        });

        var table = $('#tableCabinets').DataTable();

        $('#tableCabinets tbody').on('click', 'tr', function () {

            if ($(this).hasClass('selected')) {
                $(this).removeClass('selected');

                btnEdit.disabled = true;
                btnDelete.disabled = true;
            }
            else {
                table.$('tr.selected').removeClass('selected');
                $(this).addClass('selected');
                btnEdit.disabled = false;
                btnDelete.disabled = false;

            }

            row_array = Array.from(Object.keys(table.row(this).data()), k => table.row(this).data()[k]);

            // console.log( row_array );


        }); //fin evento click de la tabla

        //Event click to open modal with map
        $('#txtCoordinates').click(function (e) {
            $('#modalMap').modal('show');

        });

        //Event click to open modal with map to edit coordinates
        $('#editTxtCoordinates').click(function (e) {
            $('#modalMap').modal('show');

        });

        //add event to open modal with Add form
        $('#btnAdd').click(function (e) {

            $('#modalSave').modal('show');

        });

        //add event listener to save new entry
        $('#btnSave').click(function (e) {

            $.ajax({
                url: "/cabinets/add",
                type: "post",
                data: {
                    'identificador': document.getElementById("txtIdentifier").value,
                    'ubicacion': document.getElementById("txtLocation").value,
                    'latitud': document.getElementById("latitud").value,
                    'longitud': document.getElementById("longitud").value
                },
                success: function (response) {
                    // you will get response from your php page (what you echo or print) 

                    if (response == 'error') {
                        $.notify("Ha ocurrido un error", {
                            animate: {
                                enter: 'animated fadeInRight',
                                exit: 'animated zoomOutUp'
                            },
                            type: 'danger'
                        });

                        setTimeout(function () {
                            $.notifyClose();
                        }, 2200);

                    }

                    if (response == 'ok') {
                        socket.emit('notify:insert');
                    }

                    console.log(response);

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // console.log(textStatus, errorThrown);

                    $.notify("Ha ocurrido un error", {
                        animate: {
                            enter: 'animated fadeInRight',
                            exit: 'animated zoomOutUp'
                        },
                        type: 'danger'
                    });

                    setTimeout(function () {
                        $.notifyClose();
                    }, 2200);

                }
            });

            $('#modalSave').modal('hide');

        });//End clic listener btn save

        //Event click to open modal to edit data form
        $('#btnEdit').click(function (e) {

            $('#modalEditRow').modal('show');

            document.getElementById("editTxtIdentifier").value = row_array[1];
            document.getElementById("editTxtLocation").value = row_array[2];
            document.getElementById("editTxtCoordinates").value = row_array[3];

            document.getElementById("editTxtLatitude").value = row_array[3].substring(0, row_array[3].indexOf(','));
            document.getElementById("editTxtLongitude").value = row_array[3].substring(row_array[3].indexOf(',') + 1, row_array[3].length);


        });//End clic listener btn edit

        //update event listener
        $('#btnUpdate').click(function (e) {

            $.ajax({
                url: "/cabinets/update",
                type: "post",
                data: {
                    'id': row_array[0],
                    'identificador': document.getElementById("editTxtIdentifier").value,
                    'ubicacion': document.getElementById("editTxtLocation").value,
                    'latitud': document.getElementById("editTxtLatitude").value,
                    'longitud': document.getElementById("editTxtLongitude").value
                },
                success: function (response) {
                    // you will get response from your php page (what you echo or print)                 

                    if (response == 'error') {
                        $.notify("Ha ocurrido un error", {
                            animate: {
                                enter: 'animated fadeInRight',
                                exit: 'animated zoomOutUp'
                            },
                            type: 'danger'
                        });

                        setTimeout(function () {
                            $.notifyClose();
                        }, 2200);

                    }

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // console.log(textStatus, errorThrown);
                }

            });

            socket.emit('notify:update');
            btnDelete.disabled = true;
            btnEdit.disabled = true;
            $('#modalEditRow').modal('hide');


        });

        //event click to delete data in the table
        $('#btnDelete').click(function (e) {

            $.ajax({
                url: "/cabinets/delete",
                type: "post",
                data: {
                    'id': row_array[0]
                },
                success: function (response) {
                    // you will get response from your php page (what you echo or print)                 

                    console.log(response);

                },
                error: function (jqXHR, textStatus, errorThrown) {
                    // console.log(textStatus, errorThrown);
                }
            });

            socket.emit('notify:delete');
            btnDelete.disabled = true;
            btnEdit.disabled = true;

        });//End clic listener btn delete




        // Conexion del socket
        socket.on('notify:insert', function (data) {

            $('#tableCabinets').DataTable().ajax.reload();

            $.notify("Hay un nuevo registro", {
                animate: {
                    enter: 'animated fadeInRight',
                    exit: 'animated zoomOutUp'
                }
            });

            setTimeout(function () {
                $.notifyClose();
            }, 2200);


        });//End socket notify insert



        // se activa el socket cuando ocurre una eliminacion
        socket.on('notify:delete', function (data) {

            $('#tableCabinets').DataTable().ajax.reload();

            $.notify("Se elimino un registro", {
                animate: {
                    enter: 'animated fadeInRight',
                    exit: 'animated zoomOutUp'
                },
                type: 'danger'
            });

            setTimeout(function () {
                $.notifyClose();
            }, 2200);

        });//End socket notify delete


        // se activa el socket cuando ocurre un update
        socket.on('notify:update', function (data) {

            $('#tableCabinets').DataTable().ajax.reload();

            $.notify("Se actualizo un registro", {
                animate: {
                    enter: 'animated fadeInRight',
                    exit: 'animated zoomOutUp'
                }
                // type: 'info'
            });

            setTimeout(function () {
                $.notifyClose();
            }, 2200);

        });//End socket notify update

    });//End documente ready

</script>